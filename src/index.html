<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Screen Renders</title>
    <link href="https://fonts.googleapis.com/css?family=Fira+Sans+Condensed:400,700" rel="stylesheet">
    <link href="main.css" rel="stylesheet">
</head>

<body>
    <header>
        <div id="logo">
            <h1>Retro Renders</h1>
            <p id="strapline">Explore Sinclair Spectrum loading screens.</p>
        </div>
        <fieldset>
            <legend>Filter</legend>
            <label>Text
                <input type="search" id="filter" placeholder="dizzy" />
            </label>
        </fieldset>
        <fieldset>
            <legend>Options</legend>
            <label>Scale
                <select id="scale">
                    <option>1x</option>
                    <option>2x</option>
                    <option>3x</option>
                </select>
            </label>
        </fieldset>
        <fieldset>
            <legend>Results</legend>
            <span id="matchCount">0</span> fuzzy matches, showing top <span id="displayCount"></span>.
        </fieldset>
    </header>
    <content id="output">
    </content>
</body>

<script src="../lib/system.js"></script>
<script src="../dist/combined.js"></script>
<script>
    var byId = (id) => document.getElementById(id);
    var matchCount = byId('matchCount');
    var output = byId('output');
    var maxCount = 100;
    var threshold = 0.3;

    String.prototype.score = function (e, f) { if (this === e) return 1; if ("" === e) return 0; var d = 0, a, g = this.toLowerCase(), n = this.length, h = e.toLowerCase(), k = e.length, b; a = 0; var l = 1, m, c; f && (m = 1 - f); if (f) for (c = 0; c < k; c += 1)b = g.indexOf(h[c], a), -1 === b ? l += m : (a === b ? a = .7 : (a = .1, " " === this[b - 1] && (a += .8)), this[b] === e[c] && (a += .1), d += a, a = b + 1); else for (c = 0; c < k; c += 1) { b = g.indexOf(h[c], a); if (-1 === b) return 0; a === b ? a = .7 : (a = .1, " " === this[b - 1] && (a += .8)); this[b] === e[c] && (a += .1); d += a; a = b + 1 } d = .5 * (d / n + d / k) / l; h[0] === g[0] && .85 > d && (d += .15); return d };

    SystemJS.import('index').then(r => {
        var dir = '/sinclair/screens/loading/';
        var filterInput = byId('filter');
        var scaleOption = byId('scale');
        var outputContent = byId('output');
        var screenList = [];
        var loadTimer;

        filterInput.onkeyup = () => triggerLoad();
        scaleOption.onselect = () => triggerLoad();

        function triggerLoad() {
            if (loadTimer) {
                window.clearTimeout(loadTimer);
                loadTimer = null;
            }
            loadTimer = window.setTimeout(() => loadImages(), 700);
        }

        function loadImages() {
            var scale = parseInt(scaleOption.value);
            var filterText = filterInput.value;
            var results = [];

            for (var item of screenList) {
                item.score = item.title.score(filterText);
                if (item.score > threshold)
                    results.push(item);
            }

            outputContent.innerText = '';
            matchCount.innerText = results.length;
            displayCount.innerText = Math.min(results.length, maxCount);

            var count = 0;
            results.sort((a, b) => b.score - a.score);
            for (var item of results) {
                add(item);
                count++;
                if (count > maxCount) break;
            }

            function add(item) {
                var canvas = document.createElement('canvas');
                canvas.classList.add('screenshot');
                canvas.id = item.filename;
                canvas.title = item.title + ' score ' + item.score.toFixed(2);
                canvas.width = 256 * scale;
                canvas.height = 192 * scale;
                r.renderRect(dir + item.filename, canvas);
                output.appendChild(canvas);
            }
        }

        r.getAsTextLines(dir + '_list.txt')
            .then(text => screenList = text.map(l => ({
                filename: l,
                title: l.slice(0, -4).replace(/([A-Z])/g, " $1").trim()
            }))
            );
    });
</script>

</html>